<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Unity at AUT - Digital Design Studio II</title>
    <link rel="stylesheet" href="../home.css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet">
  </head>
  <body>
    <content>
      <h1>NPC Chat Tutorial</h1>
      <p><small>Or go <a href="../">back to home</a></small></p>

<!--- search for 'fixme' to see where you're up to -->
<h2>What's in this tutorial?</h2>

<ul>
  <li>Click on something to interact with it</li>
  <li>Make text appear on the screen for a few seconds</li>
  <li>keep track of how much money the player has, and other information</li>
  <li>In a different tutorial we will make a proper inventory system. You can combine that tutorial with these NPCs to make them give or take items from your inventory.</li>
</ul>

<p>This tutorial exists in slide-form as well, so if you are presenting to a class, click <a href="../week-3/">here</a></p>

<h2>Pre-setup</h2>
<p>If you already have a first person game, you can use that and skip the first step. <a href="#set-up-npcs">Skip ahead</a> to the next section.</p>
<p>If you <b>don't</b> already have a first person game, let's make one.</p>
<p>Start a new Unity project</p>
<img src="1.png">
<p>Add a Plane, using the Hierarchy view</p>
<img src="2.png">
<p>Select the plane and reset its transform, to make sure it's in the center of the world. Click on the cog icon in the top right, then choose 'Reset'</p>
<img src="3.png">
<p>Import the standard characters by clicking Assets, Import Package, Characters.</p>
<img src="4.png">
<p>Click 'Import' on the pop-up to import everything</p>
<img src="5.png">
<p>Find the First Person Controller in your Project view</p>
<img src="6.png">
<p>Drag them into your Scene view.</p>
<img src="7.png">
<p>Delete the Main Camera, because the First Person Controller comes with its own camera.</p>
<img src="8.png">
<p>Press play and check that it's working. You should be able to look around with the mouse, move with WASD and jump with spacebar.</p>
<img src="9.png">
<p>Press the stop button when you are done. You might need to press ESC to release the mouse because the First Person Controller takes control of it.</p>
<p>Now we are ready to begin.</p>

<h2 id="set-up-npcs">Set up the Game Objects</h2>

<p>We will have 2 NPCs: Cubey the Car Dealer and Sphero the Shopkeeper</p>

<p>Add a Cube to your scene.</p>
<p><img src="10.png"></p>
<p>Add a Sphere to your scene.</p>
<p><img src="11.png"></p>
<p>Rename them so we can tell what they are. (Click on their name in the Hierarchy view, right click and choose 'rename'.)</p>

<p><img src="12.png"></p>
<p><img src="13.png"></p>
<p><img src="14.png"></p>

<p>Move the objects in the scene so they start in front of the player. This will let us test them quickly.</p>

<p><img src="15.png"></p>
<p><img src="16.png"></p>

<h2>First-person click script</h2>

<p>When the player clicks:</p>
<p>We draw a 3D line out from the middle of the camera and check what it hits.</p>
<p>We want to know if it hits an NPC.</p>
<p>We'll write the script step by step.</p>
<p>Select the player in the Hierarchy</p>
<p><img src="17.png"></p>
<p>At the bottom of the Inspector, choose Add Component</p>
<p><img src="18.png"></p>
<p>Choose 'New Script' and name it 'ClickToTalk'</p>
<p><img src="19.png"></p>
<p>Edit the script by double-clicking its name here</p>
<p><img src="20.png"></p>
<h2>Player Click Script v1</h2>
<p>We are rewriting the Update function. Leave the rest of the script alone, but change the Update function to look like this:</p>
<pre><code>void Update () {
  if (Input.GetMouseButtonDown(0)) {
    print ("Click detected!");
  }
}
</code></pre>

<p>Reference: <a target="_blank" href="https://docs.unity3d.com/ScriptReference/Input.html">Unity Docs</a></p>

<p>This will display a message when the player clicks. Save your changes, run the game and check that it works.</p>

<p><img src="21.png"></p>

<h2>Player Click Script v2</h2>

<p>Now we are adding a little more to the Update Method. When the player clicks, we will trace a line out and see what it hits.</p>

<pre><code>void Update () {
  if (Input.GetMouseButtonDown(0)) {
    <b>RaycastHit hitInfo = new RaycastHit ();
    Transform camTransform = Camera.main.transform;
    bool isHit = Physics.Raycast (camTransform.position, camTransform.forward, out hitInfo);
    print(hitInfo.collider);</b>
  }
}
</code></pre>
<p>Reference: <a target="_blank" href="https://docs.unity3d.com/ScriptReference/Camera.ViewportPointToRay.html">Unity Docs</a></p>

<p>Check that it works. You should be able to click on the NPCs or the ground and their name will appear in the log.</p>


<!--- fixme: improvements up to here -->
<h2>Player Click Script v3</h2>
<p>We'll make it so you can only click on certain objects.</p>
<p>And when you click on them, we'll send them a message so they can run their own code.</p>

<pre><code>void Update () {
  if (Input.GetMouseButtonDown(0)) {
    RaycastHit hitInfo = new RaycastHit ();
    Transform camTransform = Camera.main.transform;
    bool isHit = Physics.Raycast (camTransform.position, camTransform.forward, out hitInfo);

    if (isHit &amp;&amp; hitInfo.collider.gameObject.tag.Equals ("Clickable")) {
      print ("Clickable!");
      hitInfo.collider.gameObject.SendMessage("Click");
    } else {
      print ("Not clickable");
    }
  }
}
</code></pre>
<p>Reference: <a target="_blank" href="https://docs.unity3d.com/ScriptReference/GameObject.SendMessage.html">Unity Docs</a></p>




<h2>Clickable objects v1</h2>
<p>1. Must be tagged 'Clickable'. This is how our clicking script knows that they are clickable.</p>
<p>2. Must have a script with a function called Click. This function will run when they are clicked, because we call it using SendMessage.</p>
<pre><code>void Click() {
  print("You clicked me"); //just a test
}
</code></pre>



<h2>Clickable objects v2</h2>
<pre><code>using UnityEngine.UI;

  public class CarDealer : MonoBehaviour {
  public Text chatText;

  void Start () {
    chatText.text = "";
  }

  void Click () {
    chatText.text = "I am a car dealer!";
  }
}
</code></pre>
<p>Add a Text to the scene. Drag it into the chatText slot of this script.</p>



<h2>Clickable objects v3</h2>
<p>We use a <a target="_blank" href="https://docs.unity3d.com/Manual/Coroutines.html">coroutine</a> to make the text appear then disappear. Coroutines are functions that can stop and wait, then come back later.</p>
<pre><code>using UnityEngine.UI;

  public class CarDealer : MonoBehaviour {
  public Text chatText;

  void Start () {
    chatText.text = "";
  }

  void Click () {
    StartCoroutine (WelcomeConvo ());
  }

  IEnumerator WelcomeConvo () {
    chatText.text = "I am a car dealer!";
    yield return new WaitForSeconds (2);
    chatText.text = "";
  }
}
</code></pre>

<h2>Sharing information</h2>
<p>We want every script to have access to some shared information:</p>
<p>1. How much money the player has</p>
<p>2. Does the player character like apples or bananas the most?</p>

<h2>QuestInfo script</h2>
<p>Create an empty game object in the scene. Name it 'QuestObject'. Add a script named QuestInfo. Give the script these public variables (and no functions)</p>
<pre><code>public class QuestInfo : MonoBehaviour {
  public int Money;
  public bool PlayerLikesApples;
}</code></pre>

<h2>QuestInfo script</h2>
<p>You can change the values in the Unity editor, to help test things quicky:</p>
<img src="quest-info-testing.png">

<h2>Connecting scripts</h2>
<p>Let the Car Dealer know about QuestInfo. Add this to the Car Dealer code:</p>
<pre><code>...
  public QuestInfo questInfo;
}</code></pre>
<p>Drag the QuestObject in to the slot, so it knows where to find the information:</p>
<img src="set-quest-info.png">

<h2>Using those variables</h2>
<p>We can now use those variables in our car dealer class:</p>
<pre><code>
IEnumerator WelcomeConvo () {
  if (questInfo.Money > 10) {
    chatText.text = "Want to buy a car?";
    yield return new WaitForSeconds (2);
    chatText.text = "";
  } else {
    chatText.text = "Come back when you have $10.";
    yield return new WaitForSeconds (2);
    chatText.text = "";
  }
}
</code></pre>

<h2>Connecting scripts v2</h2>
<p>I get tired of dragging QuestInfo object into every script that needs QuestInfo. Let's make them link up automatically!</p>
<pre><code>
  //Replace the word 'public' with 'private'
  private QuestInfo questInfo;

  void Start () {
    //automatically link up at the start of the game:
    questInfo = FindObjectOfType(typeof(QuestInfo));
  }
</code></pre>
    </content>

    <h2>Dialogue options</h2>

    <p>When the player clicks on an NPC, we want to let them make a choice.</p>

    <p>We will show them two buttons and let them click on one. Becuase the First Person Controller takes control of our mouse, we need to disable it before we can turn the mouse cursor back on.</p>

    <p>Add two buttons in the Scene View (Create->UI->Button). Name them YesButton and NoButton and change the text inside them to 'Yes' and 'No'</p>

    <p>Make a new gameobject, a Cylinder, tag it as Clickable, and add a new script named Friend. Put this code in the script:</p>
  <pre><code>using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityStandardAssets.Characters.FirstPerson;

public class Friend : MonoBehaviour {

	public Text chatText;
	public Button yesButton;
	public Button noButton;
	public FirstPersonController fps;

	public void Start () {
		chatText.text = "";
		yesButton.gameObject.SetActive (false);
		noButton.gameObject.SetActive (false);
	}

	public void Click() {
		chatText.text = "Can we go to the beach?";
		yesButton.gameObject.SetActive (true);
		noButton.gameObject.SetActive (true);
		fps.enabled = false; //stop the FPS controller from controlling the mouse
		//turn mouse cursor back on
		Cursor.lockState = CursorLockMode.None;
		Cursor.visible = true;
		yesButton.onClick.AddListener (ChoseYes);
		noButton.onClick.AddListener (ChoseNo);
	}

	public void ChoseYes () {
		//let FPS controller control the mouse again
		fps.enabled = true;
		chatText.text = "YAY!";
		yesButton.gameObject.SetActive (false);
		noButton.gameObject.SetActive (false);
	}

	public void ChoseNo () {
		//let FPS controller control the mouse again
		fps.enabled = true;
		chatText.text = "AWWW";
		yesButton.gameObject.SetActive (false);
		noButton.gameObject.SetActive (false);
	}
}
  </code></pre>

<p>For the script to work, you need to drag the appropriate objects into it in the Inspector: the Chat Text, the two buttons, and the FPS Controller.</p>

<p><img src="friend-inspector.png"></p>

  </body>
</html>
